<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Angular Material style sheet -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.0/angular-material.css">
	
	<style>
		.selected {
			background-color: rgba(255,255,255,.15);
		}
		
		div.button {
			outline:none;
 			cursor: pointer;
		}
	</style>
</head>

<body ng-app="coffeLight" ng-cloak>
    
	<link rel="manifest" href="/manifest.json">
	<script src="./resize-observer-polyfill.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-messaging.js"></script>
	<script src="./firebase.js"></script>
	<script type="text/javascript">
	
		var coffeeLight = coffeeLight || {};
		coffeeLight.size = 0.7;
		
		coffeeLight.loadName = () => {
			name = localStorage.getItem("coffeeLight.name") || "Coffee Lover";
			return name;
		};
		
		coffeeLight.changeName = (name) => {
			localStorage.setItem("coffeeLight.name", name);
			changeName(name);
		};
		
		coffeeLight.setStyle = () => {
			coffeeLight.button = coffeeLight.button || document.getElementById("button");
			coffeeLight.handle = coffeeLight.handle || document.getElementById("handle");
			var parent = coffeeLight.button.parentElement;
			var availableSpace = Math.min(parent.offsetHeight, parent.offsetWidth);
			var diameter = coffeeLight.size * availableSpace;
			
			coffeeLight.button.style.width  = diameter + "px";
			coffeeLight.button.style.height = diameter + "px";
			coffeeLight.button.style.fontSize = 1.5 * diameter + "%";
			coffeeLight.button.style.borderWidth = 0.04 * diameter + "px";
			coffeeLight.button.style.margin = ((parent.offsetHeight - diameter)/2 + "px") + " " + ((parent.offsetWidth - diameter)/2 + "px");
			
			if(self.renderer) {
				renderer.setSize( diameter,diameter );
				renderer.render( scene, camera );
			}
		}
	</script>
	<script src="app.js"></script>

    <!-- Angular Material requires Angular.js Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-aria.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular-messages.min.js"></script>

    <!-- Angular Material Library -->
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.4/angular-material.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/86/three.js"></script>
	<script src="./styles/kicker.js"></script>
	<script src="./styles/coffee.js"></script>

    <!-- Your application bootstrap  -->
    <script type="text/javascript">
        angular
            .module('coffeLight', ['ngMaterial', 'ngMessages'])
            .controller('AppCtrl', function($scope, $timeout, $mdSidenav, $log, $mdDialog, $mdToast) {
				$scope.toggleLeft = buildDelayedToggler('left');
				
				angular.element(document).ready(function () {
					console.log("ready");
					coffeeLight.setStyle();
				});

				window.onload = () => {
					new ResizeObserver(coffeeLight.setStyle).observe(document.getElementById("buttonContainer"));
					
					scene = new THREE.Scene(); // dummy scene
					camera = new THREE.PerspectiveCamera( 30, 1, 0.1, 1000 );
					camera.position.z = 12;
					renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
					renderer.setPixelRatio(window.devicePixelRatio ? window.devicePixelRatio : 1);
					renderer.setClearColor("green",0);
					
					renderer.render( scene, camera );
					
					var b = document.getElementById("button");
					renderer.setSize( b.offsetWidth, b.offsetHeight );
					renderer.domElement.style.top = "0px";
					renderer.domElement.style.position = "absolute";
					b.insertBefore(renderer.domElement, b.firstElementChild);
				};
				
				window.onhashchange = () => {
					var fn = () => {
						var newId = parseInt(window.location.hash.replace(/[^0-9]/g, ""));
						if(isNaN(newId)) {
							return;
						}
						$scope.activeGroupId = newId;
					}
					if($scope.$$phase == "$apply") {
						fn();
					}
					else {
						$scope.$apply(fn);
					}
				};
				window.onhashchange();
				
				$scope.name = coffeeLight.loadName();
				
				$scope.joinGroup = (group, password) => {
					subscribeToChannel(group.id, password)
					.then($scope.hideDialog)
					.then(updateGroupsBinding)
					.catch(handleFetchError);
				};
				
				function handleFetchError(res) {
					if(res.status === 400) {
						return res.json().then(err => $scope.showError(err.error));
					}
					else {
						return res.text().then((text) => {
							console.error("Unkowen Request error:", text, res);
							$scope.showError("Unkown error occured");
						});
					}
				}

				$scope.showError =  msg => {
					console.error(msg);
					$mdToast.show(
					  $mdToast.simple()
						.textContent(msg)
						.hideDelay(3000)
					);
				};
				
				$scope.buttonClicked = (event, style) => {
					sendNotification($scope.activeGroupId).catch(res => {
						if(res.status === 400) {
							res.json().then((e) => {
								if(e.code == 429) {
									console.log("Notify Rate Limited");
								} else {
									$scope.showError(e.error)
								}
							});
						} else {
							handleFetchError(res);
						}
					});
					style.animate(renderer, event);
				};
				
				$scope.$watch("activeGroupId", (id) => {
					if(id) {
						getChannel(id).then(result => {
							if(result.channel.id == id) { // in case selection changed until request finished
								$scope.$apply(() => {
									$scope.activeGroup = result.channel;
								});
							}
						}).catch(handleFetchError);
					}
				});
				
				$scope.$watch("activeGroup.type", (style) => {
					console.log(coffeeLight.styles, style);
					if(style && coffeeLight.styles[style]) {
						scene = coffeeLight.styles[style].getScene();
						renderer.render(scene, camera);
						$scope.style = coffeeLight.styles[style];
					}
				});
				
				
				$scope.groups = [{"name" : "Loading..."}];
				function updateGroupsBinding() {
					return getSubscripedChannels().then((groups) => {
						$scope.$apply(() => {
							$scope.groups = groups;
							if(!$scope.activeGroupId && groups.length > 0) {
								$scope.activeGroupId = groups[0].id;
							}
						}); 
					});
				}
				updateGroupsBinding();

				$scope.leaveGroup = function(groupid) {
					unsubscribeFromChannel(groupid).then(updateGroupsBinding).catch(handleFetchError); 
				}
				
				$scope.activateGroup = (id) => {
					$mdSidenav('left').close();
					$scope.activeGroupId = id;
					window.location.hash = id;
				}
				
				$scope.showSetName = function(ev) {
					var confirm = $mdDialog.prompt()
					  .title("What's your name?")
					  .placeholder('Name')
					  .ariaLabel('Name')
					  .initialValue(auth.currentUser ? auth.currentUser.displayName : 'Coffee Lover')
					  .targetEvent(ev)
					  .ok('Save')
					  .cancel('Cancel');

					$mdDialog.show(confirm).then(function(result) {
						coffeeLight.changeName(result);
						$scope.name = coffeeLight.loadName();
					}, function() {
						// ignore
					});
				};

				$scope.searchGroups = query => {
					return searchChannels(query).then(r => r.channels).catch(handleFetchError);
				};
				
				function showDialogFactory(id) {
					return ev => {
						console.log("opening dialog " + id);
						$mdDialog.show({
							clickOutsideToClose: true,
							contentElement     : "#" + id,
							parent             : angular.element(document.body),
							targetEvent        : ev
						});
					};
				}
				
				$scope.createGroup = {};
				$scope.showJoinGroup = showDialogFactory("dialogJoin");
				$scope.showCreateGroup = showDialogFactory("dialogCreate");
				$scope.createGroupSubmit = () => {
					var options = {
						name: $scope.createGroup.name,
						password: $scope.createGroup.password || undefined,
						type: $scope.createGroup.type || undefined,
						message: $scope.createGroup.message || undefined
					};
					$scope.createGroup = {};
					
					console.log("Create Channel", options);
					createChannel(options)
						.then($scope.hideDialog)
						.then(updateGroupsBinding)
						.catch(handleFetchError);
				};
				
				$scope.hideDialog = function() {
					$mdDialog.hide();
				};


                function debounce(func, wait, context) {
                    var timer;

                    return function debounced() {
                        var context = $scope,
                            args = Array.prototype.slice.call(arguments);
                        $timeout.cancel(timer);
                        timer = $timeout(function() {
                            timer = undefined;
                            func.apply(context, args);
                        }, wait || 10);
                    };
                }

                function buildDelayedToggler(navID) {
                    return debounce(function() {
                        $mdSidenav(navID)
                            .toggle()
                            .then(function() {
                                $log.debug("toggle " + navID + " is done");
                            });
                    }, 200);
                }

                function buildToggler(navID) {
                    return function() {
                        $mdSidenav(navID)
                            .toggle()
                            .then(function() {
                                $log.debug("toggle " + navID + " is done");
                            });
                    };
                }
            })
			.config(function($mdIconProvider, $sceDelegateProvider) {
				$sceDelegateProvider.resourceUrlWhitelist(["self", "https://raw.githubusercontent.com/google/**"]);
				$mdIconProvider
				.iconSet('navigation', "https://raw.githubusercontent.com/google/material-design-icons/master/sprites/svg-sprite/svg-sprite-navigation.svg", 24)
				.iconSet('social',     "https://raw.githubusercontent.com/google/material-design-icons/master/sprites/svg-sprite/svg-sprite-social.svg", 24);
			})
			.config(function($mdThemingProvider) {
				$mdThemingProvider.theme('default').primaryPalette('orange').dark();
			});

    </script>

    <div ng-controller="AppCtrl" layout="column" style="height:100%;" ng-cloak>

        <section layout="row" flex>

            <md-sidenav 
				layout="column"
				class="md-sidenav-left md-whiteframe-z2 md-navigation-drawer" md-component-id="left" md-is-locked-open="$mdMedia('gt-md')" md-whiteframe="4">

                <md-toolbar class="md-theme-indigo">
                    <h1 class="md-toolbar-tools">Hello {{name}}</h1>
                </md-toolbar>
					
					<div layout="column" layout-align="space-between stretch" style="height: 100%;">
					   <md-list>
						  <md-list-item ng-class="activeGroupId == group.id ? 'selected' : false" 
							ng-click="activateGroup(group.id)" ng-repeat="group in groups" role="link">
							<p>{{group.name}}</p>
							  <md-button ng-click="leaveGroup(group.id)" class="md-icon-button md-secondary">
								<md-icon md-svg-icon="navigation:ic_cancel_24px""></md-icon>
							  </md-button>
						  </md-list-item>
						  
					  </md-list>
					  
					  <md-list>
						  <md-divider></md-divider>
						  <md-list-item ng-click="showSetName($event)" role="link">
							<!--TODO: find icon <md-icon md-svg-icon="social:ic_group_add_24px"></md-icon>-->
							<p class="md-body-2">Change Name</p>
						  </md-list-item>
						  <md-list-item ng-click="showJoinGroup($event)" role="link">
							<md-icon md-svg-icon="social:ic_group_add_24px"></md-icon>
							<p class="md-body-2">Join a Group</p>
						  </md-list-item>
						  <md-list-item ng-click="showCreateGroup($event)" role="link">
							<md-icon md-svg-icon="social:ic_group_add_24px"></md-icon>
							<p class="md-body-2">Create a Group</p>
						  </md-list-item>
					  </md-list>
				  </div>

            </md-sidenav>

			<md-content layout="column" layout-fill>
				<md-toolbar class="animate-show md-whiteframe-z1">
					<div class="md-toolbar-tools">
						<md-button class="md-icon-button" ng-click="toggleLeft()" hide-gt-sm aria-label="Menu">
							<md-icon md-svg-icon="navigation:ic_menu_24px" aria-label="Menu"></md-icon>
						</md-button>
					</div>
				</md-toolbar>
				
				<md-content  style="overflow: hidden;" id="buttonContainer" flex layout-padding>
					<div ng-click="buttonClicked($event, style)" id="button" style="position: absolute" class="button">
						<div style="position: absolute; text-align: center; top: 50%; transform: translateY(-50%);">{{activeGroup.requestText}}</div>
					</div>
				</md-content>
			</md-content>
				
        </section>
		
		<div style="visibility: hidden">
			<div class="md-dialog-container" id="dialogCreate">
			  <md-dialog layout-padding="">
				  <form name="createGroup" ng-submit="createGroupSubmit()">
					<h2>Create Group</h2>
					<div class="flex flex-col">
						<md-input-container class="md-block">
							<label>Name</label>
							<input type="text" required ng-model="createGroup.name">
						</md-input-container>
						<md-input-container class="md-block">
							<label>Password</label>
							<input type="password" ng-model="createGroup.password">
						</md-input-container>
						<md-input-container class="md-block">
							<label>Type</label>
							<md-select ng-model="createGroup.type">
								<md-option value="coffee" selected>Coffee</md-option>
								<md-option value="lunch">Lunch</md-option>
								<md-option value="kicker">Kicker</md-option>
							</md-select>
						</md-input-container>
						<md-input-container class="md-block">
							<label>Message</label>
							<input placeholder="%n wants %c" type="text" ng-model="createGroup.message">
						</md-input-container>
					</div>
					<div layout-align="center" layout="row">
					  <md-button aria-label="Cancel" class="md-primary" type="reset" ng-click="hideDialog()" >Cancel</md-button>
					  <md-button aria-label="Create" class="md-primary" type="submit">Create</md-button>
					</div>
				</form>
			  </md-dialog>
			</div>
			
			<div class="md-dialog-container" id="dialogJoin">
			  <md-dialog layout-padding="">
				<h2>Join Group</h2>
				<!-- Theming should be fixed in angular material 1.2.0 (Due by September 22, 2017) -->
				<md-autocomplete class="md-accent" md-no-cache="true"
					md-selected-item="joinGroupSelected"
					md-search-text="searchText"
					md-items="item in searchGroups(searchText)"
					md-item-text="item.name"
					md-min-length="0"
					placeholder="Name">
					<md-item-template>
					  <span md-highlight-text="searchText" md-highlight-flags="^i">{{item.name}}</span>
					</md-item-template>
					<md-not-found>
					  No groups matching "{{searchText}}" were found.
					</md-not-found>
				</md-autocomplete>
				<md-input-container class="md-block">
						<label>Password</label>
						<input ng-disabled="!joinGroupSelected.hasPassword" autocomplete="new-password" type="password" ng-model="joinGroupPassword">
				</md-input-container>
				<div layout-align="center" layout="row">
				  <md-button aria-label="Cancel" class="md-primary" ng-click="hideDialog()">Cancel</md-button>
				  <md-button aria-label="Join"   class="md-primary" ng-click="joinGroup(joinGroupSelected, joinGroupPassword)">Join</md-button>
				</div>
			  </md-dialog>
			</div>
		</div>

    </div>

</body>

</html>